<?php
// Copyright 1999-2016. Parallels IP Holdings GmbH.
class ApiController extends pm_Controller_Action
{
    public function listAction()
    {
        \pm_Log::info('Retrieve list of composer.lock files');

        $client = pm_Session::getClient();
        $domains = $client->isAdmin() ?
            pm_Domain::getAllDomains() :
            pm_Domain::getDomainsByClient($client);

        $list = array_reduce(array_map(function (pm_Domain $domain) {
            $fileManager = new pm_FileManager($domain->getId());
            return array_map(function ($composerLockPath) use ($domain) {
                return [
                    'domainId' => $domain->getId(),
                    'domainName' => $domain->getDisplayName(),
                    'composerLockPath' => $composerLockPath,
                ];
            }, $fileManager->find(['composer.lock']));
        }, $domains), function ($carry, $composerLocks) {
            $carry = array_merge($carry, $composerLocks);
            return $carry;
        }, []);

        $this->_helper->json($list);
    }
}
