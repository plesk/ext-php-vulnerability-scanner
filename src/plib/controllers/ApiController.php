<?php

use PleskExt\PhpVulnerabilityScanner\ComposerLock;

class ApiController extends \pm_Controller_Action
{
    public function scanAction()
    {
        \pm_Log::info('Scan composer.lock files thought existing domains');

        $client = pm_Session::getClient();
        $domains = $client->isAdmin() ?
            pm_Domain::getAllDomains() :
            pm_Domain::getDomainsByClient($client);

        $list = array_reduce(array_map(function (pm_Domain $domain) {
            $fileManager = new pm_FileManager($domain->getId());
            return array_map(function ($composerLockPath) use ($domain) {
                return [
                    'domainId' => $domain->getId(),
                    'domainName' => $domain->getDisplayName(),
                    'composerLockPath' => $composerLockPath,
                ];
            }, $fileManager->find(['composer.lock']));
        }, $domains), function ($carry, $composerLocks) {
            $carry = array_merge($carry, $composerLocks);
            return $carry;
        }, []);

        $composerLock = new ComposerLock();
        $composerLock->setList($list);

        $this->_helper->json($list);
    }

    public function listAction()
    {
        $composerLock = new ComposerLock();
        $this->_helper->json($composerLock->getList());
    }
}
